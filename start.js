var W,H;
var ctx,canvas,audioCtx,decor,canvasFond;
var source;
var rythme = 1000;
var nextR = 1000;
var img = {};
var keys = [];
var actions = ["p0","p0","p0","p0"];
var scrollAct = 0;
var touche = 0;
var select = 0;
var heros = new Perso();
var elements = [];
var actual = ["","","","","","","","","","","","","",""];
var particles = [[""],[""],[""],[""],[""],[""],[""],[""],[""],[""],[""],[""],[""],[""],[""]];
var goOn = 1;

var lines = [0.1,0.3,0.5,0.7,0.9];
var currentNotes = [];
var nNotes = 0;
// Notes sous la forme : [nLigne,temps,type]  type  0 : point simple
var notes = [[2,1.856666,0],[2,2.098911,0],[2,2.341405,0],[2,2.583832,0],[2,2.907845,0],[2,3.232108,0],[2,3.515396,0],[2,3.838707,0],[3,4.121972,0],[3,4.445351,0],[3,4.769727,0],[3,5.052607,0],[3,5.33585,0],[3,5.619183,0],[3,5.902539,0],[3,6.226417,0],[2,6.470204,0],[2,6.793628,0],[2,7.076326,0],[2,7.400136,0],[2,7.683718,0],[2,8.007392,0],[2,8.290725,0],[2,8.574149,0],[2,8.897891,0],[2,9.181043,0],[2,9.504648,0],[2,9.787709,0],[2,10.111065,0],[2,10.394104,0],[2,10.677505,0],[2,10.960317,0],[3,11.245646,0],[2,11.89297,0],[3,12.458956,0],[4,13.065736,0],[2,14.240408,0],[3,14.847074,0],[4,15.412834,0],[2,15.978616,0],[3,16.66678,0],[4,17.273922,0],[2,17.841269,0],[0,18.448888,0],[2,19.055124,0],[3,19.662131,0],[4,20.228458,0],[0,20.794693,0],[2,21.439954,0],[3,22.006394,0],[4,22.614421,0],[0,23.261814,0],[2,23.868185,0],[3,24.475147,0],[4,25.041292,0],[0,25.646734,0],[2,26.254263,0],[3,26.860839,0],[4,27.42687,0],[0,28.03297,0],[2,28.683038,0],[3,29.290022,0],[4,29.895918,0],[2,30.462721,0],[3,31.11043,0],[4,31.676825,0],[0,32.243582,0],[0,32.851292,0],[2,33.498344,0],[3,34.064126,0],[4,34.631269,0],[0,35.238185,0],[2,35.884784,0],[3,36.492267,0],[4,37.058843,0],[0,37.666757,0],[2,38.273219,0],[3,38.839433,0],[4,39.446009,0],[0,40.013514,0],[2,40.660317,0],[3,41.227097,0],[4,41.873786,0],[0,42.481043,0],[2,43.451473,0],[3,43.653809,0],[0,44.867301,0],[0,45.474671,0],[0,46.081292,0],[0,46.769637,0],[0,47.335804,0],[0,47.901814,0],[0,48.508004,0],[0,49.114897,0],[2,49.681632,0],[3,50.370045,0],[4,50.532471,0],[2,50.694217,0],[3,50.855691,0],[2,50.855691,0],[4,51.502857,0],[2,52.109977,0],[3,53.323287,0],[0,54.538276,0],[2,55.105895,0],[3,55.711405,0],[4,56.235532,0],[0,56.883129,0],[2,59.391224,0],[3,59.957528,0],[4,60.483628,0],[2,61.131156,0],[3,61.737687,0],[2,64.085759,0],[3,66.473673,0],[4,68.941224,0],[2,71.246938,0],[3,72.501133,0],[2,73.673968,0],[2,74.645464,0],[3,76.06,0],[3,76.989387,0],[4,77.918866,0],[2,78.4856,0],[3,79.374625,0],[4,80.830544,0],[2,81.678639,0],[3,82.690453,0],[4,83.256938,0],[2,84.147188,0],[3,85.604126,0],[3,86.534557,0],[4,87.424761,0],[4,88.031541,0],[2,89.042562,0],[2,90.460226,0],[2,91.308752,0],[3,92.886145,0],[3,95.271972,0],[3,96.405079,0],[4,96.89043,0],[2,97.374557,0],[3,97.698526,0],[4,98.063015,0],[2,98.831292,0],[0,100.084444,0],[2,102.473151,0],[3,103.604195,0],[4,104.979319,0],[2,106.110634,0],[3,106.555034,0],[4,106.959818,0],[2,107.28331,0],[3,107.687301,0],[0,108.172403,0],[2,108.496258,0],[4,112.096099,0],[3,113.26916,0],[2,114.481746,0],[2,116.626303,0],[3,116.909841,0],[4,117.315419,0],[2,117.719546,0],[3,118.042335,0],[2,119.295782,0],[3,119.700566,0],[4,120.105124,0],[2,120.509863,0],[3,120.954875,0],[4,121.319024,0],[2,121.643401,0],[2,125.325192,0],[3,125.770385,0],[4,126.134875,0],[2,126.457641,0],[3,126.903922,0],[4,127.30873,0],[2,127.631678,0],[2,128.886213,0],[3,129.331451,0],[4,129.73526,0],[2,130.140362,0],[3,130.585147,0],[4,130.94882,0],[2,131.232925,0],[3,136.08585,0],[4,140.819274,0],[2,145.632925,0],[3,148.101065,0],[2,150.488888,0],[3,152.632517,0],[4,152.794512,0],[2,152.957301,0],[3,154.090362,0],[4,154.9817,0],[2,155.184058,0],[3,155.305283,0],[4,156.480362,0],[2,157.369682,0],[3,157.571836,0],[4,157.733673,0],[2,158.138344,0],[3,158.58365,0],[4,158.867074,0],[2,159.47356,0],[3,160.080362,0],[3,160.323378,0],[3,160.646757,0],[3,160.929818,0],[3,161.253854,0],[3,161.57712,0],[3,161.860249,0],[3,162.183129,0],[3,162.466326,0],[3,162.78975,0],[3,163.113265,0],[3,163.396938,0],[3,163.68009,0],[3,164.003265,0],[3,164.286621,0],[3,164.610045,0],[3,164.933469,0],[3,165.258526,0],[3,165.541541,0],[3,165.824557,0],[3,166.147845,0],[3,166.432131,0],[3,166.959024,0],[2,167.200975,0],[3,167.323015,0],[4,167.727732,0],[2,168.172517,0],[3,168.49585,0],[4,169.061814,0],[2,169.709637,0],[2,169.993106,0],[2,170.317006,0],[2,170.640816,0],[2,170.923424,0],[2,171.247619,0],[2,171.532312,0],[2,171.85551,0],[2,172.138253,0],[2,172.421428,0],[2,172.744784,0],[2,173.028798,0],[2,173.352585,0],[2,173.63551,0],[2,173.919206,0],[2,174.202244,0],[3,174.525827,0],[3,174.849659,0],[3,175.091972,0],[3,175.415804,0],[3,175.698458,0],[3,175.98136,0],[3,176.30517,0],[3,176.588072,0],[3,176.912267,0],[3,177.195578,0],[3,177.519569,0],[3,177.80238,0],[3,178.085464,0],[3,178.328299,0],[3,178.692176,0],[3,178.975782,0],[4,179.259433,0],[2,179.906893,0],[3,180.472993,0],[4,181.038888,0],[2,182.211768,0],[3,182.819569,0],[4,183.426961,0],[2,184.640249,0],[3,185.206303,0],[4,185.81399,0],[2,186.987551,0],[3,187.594875,0],[4,188.161383,0],[2,188.808798,0],[3,189.45678,0],[4,190.023401,0],[0,190.630589,0],[2,191.277913,0],[3,191.845464,0],[4,192.453333,0],[2,193.060226,0],[3,193.667324,0],[4,194.274036,0],[2,194.880453,0],[3,195.448072,0],[4,196.054353,0],[2,196.661564,0],[3,197.269682,0],[4,197.87653,0],[2,198.484512,0],[3,199.132244,0],[4,199.69873,0],[2,200.224648,0],[3,200.831814,0],[4,201.439523,0],[2,202.087369,0],[3,202.613424,0],[4,203.221496,0],[2,203.868571,0],[3,204.47526,0],[4,205.042063,0],[2,205.649614,0],[3,206.257777,0],[4,206.864807,0],[2,207.432834,0],[2,207.999365,0],[3,208.68653,0],[4,209.251836,0],[2,209.858979,0],[3,210.304126,0],[4,210.466213,0]];
var largeur = 10;
var horizon = 10;
var vision = 2;

var particles = [];

var level = "jin";


//donnee


// programme

function rnd(max){
    return Math.floor(Math.floor(Math.random()*max));
}

function charge(){
    var imgL = ["p0","p1","p2","null","arbre","porte"];
    var chargement = imgL.length;
    imgL.forEach(
        function(e,i){
            img[e] = new Image();
            img[e].src = "images/" + e + ".png";
            img[e].onload = function(){
                chargement -= 1;
                if (chargement == 0) beginMusic(level);
            };
        }
    );
}

function resize(){
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.setAttribute("width",W);
    canvas.setAttribute("height",H);
    largeur = W/20;
    horizon = H/10 * 9;
}

function move(x,y){

}

function click(x,y){

}

function onTouch(evt){
    resize();
    var x = evt.clientX;
    // On vérifie d'abord l'appartenance à une éventuelle colonne.
    lines.forEach(
        function(e,i){
            var realX = e*W;
            if (Math.abs(x - realX) < largeur){
                // Ok on a touché une colonne.
                currentNotes.forEach(
                    function(f,j){
                        if (f[0] == i){
                            if (Math.abs(source.currentTime - f[1]) < 0.2){
                                addParticles(realX);
                                if (nNotes < notes.length){
                                    currentNotes[j] = notes[nNotes];
                                    nNotes += 1;
                                }
                            }
                        }
                    }
                );
            }
        }
    );

}

function start(){
    canvas = document.querySelector("#canvas");
    ctx = canvas.getContext("2d");
    W = canvas.width;
    H = canvas.height;
    resize();
    document.addEventListener("touchstart", onTouch, false);
    document.addEventListener("mousedown", onTouch, false);
    document.addEventListener(
        "keydown",
        function (event){
            event.preventDefault();
            event.stopPropagation();
            if (keys[event.keyCode] != 1){
                keys[event.keyCode] = 1;
                touche += 1;
            }
            if (goOn == 0) relife();
        }
    );
    document.addEventListener(
        "keyup",
        function (event){
            event.preventDefault();
            event.stopPropagation();
            touche -= 1;
            keys[event.keyCode] = 0;
        }
    );
    charge();
}

function animation(){
    var f = function(t) {
        paint(t);
        window.requestAnimationFrame(f);
    };
    window.requestAnimationFrame(f);
}

function paint(t){
    ctx.fillStyle = "rgb(0,0,0)";
    ctx.fillRect(0,0,W,H);
    ctx.globalAlpha = 0.2;
    drawNotes(source.currentTime);
    act(source.currentTime);
    ctx.globalAlpha = 1;
    drawParticles(particles);
}

function beginMusic(src){
    notes = stages[src];
    source = new Audio();
    source.src = "musiques/" + src + ".ogg";
    source.play();
    source.volume = 0.5;
    console.log(source);
    for (var i = 0;i < 10;i++){
        currentNotes[i] = notes[i];
        nNotes += 1;
    }
    animation();
}

function act(t){
    currentNotes.forEach(
        function(e,i){
            if (e[1] < t){
                if (nNotes < notes.length){
                    currentNotes[i] = notes[nNotes];
                    nNotes += 1;
                }
            }
        }
    );
}

function addParticles(x){
    particles.push({x:x,y:horizon,s:largeur/2,type:0,n:largeur/16,trans:1,limite:W/8});
    particles.push({x:x+largeur/2,y:horizon-largeur/2,s:largeur/8,type:0,n:largeur/32,trans:1,limite:W/128});
}

start();
